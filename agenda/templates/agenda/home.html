<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h2>Pedido de Reunião</h2>

    <!-- Formulário para solicitar uma reunião -->
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Solicitar Reunião</button>
    </form>
    
    <hr>
    
    <h2>Pedidos de Reunião</h2>
    
    {% if reunioes %}
        <table class="table">
            <thead>
                <tr>
                    <th>Solicitante</th>
                    <th>Local</th>
                    <th>Data Início</th>
                    <th>Data Fim</th>
                    <th>Horário Início</th>
                    <th>Horário Fim</th>
                    <th>Colaboradores</th>
                    <th>Descrição</th>
                    <th>Status</th>
                    {% if user.is_staff %}  <!-- Se for um administrador, mostrar ações -->
                        <th>Ações</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for reuniao in reunioes %}
                    <tr>
                        <td>{{ reuniao.criado_por.nome }}</td>  <!-- Mostra quem fez o pedido -->
                        <td>{{ reuniao.local.nome }}</td>
                        <td>{{ reuniao.data_inicio|date:"d/m/Y" }}</td>
                        <td>{{ reuniao.data_fim|date:"d/m/Y" }}</td>
                        <td>{{ reuniao.horario_inicio|time:"H:i" }}</td>
                        <td>{{ reuniao.horario_fim|time:"H:i" }}</td>
                        <td>
                            {% for colaborador in reuniao.colaboradores.all %}
                                {{ colaborador.nome }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </td>
                        <td>{{ reuniao.descricao }}</td>
                        <td>
                            <span class="badge {% if reuniao.status == 'APROVADO' %}bg-success{% elif reuniao.status == 'REJEITADO' %}bg-danger{% else %}bg-warning{% endif %}">
                                {{ reuniao.status }}
                            </span>
                        </td>
                        {% if user.is_staff %}
                            <td>
                                <a href="{% url 'aprovar_reuniao' reuniao.id %}" class="btn btn-success btn-sm">Aprovar</a>
                                <a href="{% url 'rejeitar_reuniao' reuniao.id %}" class="btn btn-danger btn-sm">Rejeitar</a>
                            </td>
                        {% endif %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Nenhum pedido de reunião encontrado.</p>
    {% endif %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const dataInicioInput = document.getElementById("id_data_inicio");
            const horarioInicioInput = document.getElementById("id_horario_inicio");
            const horarioFimInput = document.getElementById("id_horario_fim");
            const colaboradoresSelect = document.getElementById("id_colaboradores");
        
            function atualizarColaboradores() {
                const data_inicio = dataInicioInput.value;
                const horario_inicio = horarioInicioInput.value;
                const horario_fim = horarioFimInput.value;
        
                if (data_inicio && horario_inicio && horario_fim) {
                    fetch(`/colaboradores-disponiveis/?data_inicio=${data_inicio}&horario_inicio=${horario_inicio}&horario_fim=${horario_fim}`)
                        .then(response => response.json())
                        .then(data => {
                            colaboradoresSelect.innerHTML = "";
                            
                            if (data.colaboradores.length === 0) {
                                const option = document.createElement("option");
                                option.text = "Nenhum colaborador disponível";
                                option.disabled = true;
                                colaboradoresSelect.appendChild(option);
                            } else {
                                data.colaboradores.forEach(colaborador => {
                                    const option = document.createElement("option");
                                    option.value = colaborador.id;
                                    option.text = colaborador.nome;
                                    colaboradoresSelect.appendChild(option);
                                });
                            }
                        });
                }
            }
        
            dataInicioInput.addEventListener("change", atualizarColaboradores);
            horarioInicioInput.addEventListener("change", atualizarColaboradores);
            horarioFimInput.addEventListener("change", atualizarColaboradores);
        });
        </script>
</body>
</html>